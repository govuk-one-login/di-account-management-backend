AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "A template to create the GOV.UK One login Account backend infrastructure."

Parameters:
  UserServicesStoreTableName:
    Type: String
    Default: user_services
  RawEventsStoreTableName:
    Type: String
    Default: raw_events
  ActivityLogsStoreTableName:
    Type: String
    Default: activity_logs
  DummyEventStoreTableName:
    Type: String
    Default: dummy_events
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: must be dev, build, staging, integration or production
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
    Default: vpc-enhanced
  CodeSigningConfigArn:
    Type: String
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Default: "none"
  PermissionsBoundary:
    Type: String
    Description: >
      The ARN of the permissions boundary to apply to any role created by the template
    Default: "none"
  AccountManagementFrontendStackName:
    Type: String
    Default: account-mgmt-frontend
  ProductTagValue:
    Description: Value for the Product Tag
    Type: String
    Default: GOV.UK Sign In
  OwnerTagValue:
    Description: Value for the Owner Tag
    Type: String
    Default: govuk-accounts-tech@digital.cabinet-office.gov.uk
  SourceTagValue:
    Description: Value for the Source Tag
    Type: String
    Default: alphagov/di-account-management-backend/deploy/template.yaml
  SystemTagValue:
    Description: Value for the System Tag
    Type: String
    Default: Accounts

Conditions:
  UseCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"

  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"

  IsNotDevelopment:
    Fn::Not:
      - Fn::Equals:
          - !Ref Environment
          - "dev"

  UseInternalEvents: !Or
    - !Equals [!Ref Environment, dev]
    - !Equals [!Ref Environment, build]

  ExportLogsToSplunk:
    Fn::Or:
      - !Equals [!Ref Environment, staging]
      - !Equals [!Ref Environment, integration]
      - !Equals [!Ref Environment, production]

  IsNotProdOrIntegration:
    Fn::Or:
      - !Equals [ !Ref Environment, build ]
      - !Equals [ !Ref Environment, dev ]
      - !Equals [ !Ref Environment, staging ]

Globals:
  Function:
    Environment:
      Variables:
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CONNECTION_BASE_URL: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CLUSTER_ID: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_TENANT: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: "true"
    Architectures: ["arm64"]
    MemorySize: 128
    KmsKeyArn: !GetAtt LambdaKMSKey.Arn
    ReservedConcurrentExecutions: 10
    Runtime: nodejs18.x
    Timeout: 5
    VpcConfig:
      SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    Layers:
      - !Sub
        - '{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}'
        - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]

Mappings:
  InputQueue:
    dev:
      QueueArn: ""
      KeyArn: ""
    build:
      QueueArn: ""
      KeyArn: ""
    staging:
      QueueArn: "arn:aws:sqs:eu-west-2:178023842775:self-staging-EC-SQS-Output-Queue-accounts"
      KeyArn: "arn:aws:kms:eu-west-2:178023842775:key/6dbe7362-a125-466b-a135-22c98c436f17"
    integration:
      QueueArn: "arn:aws:sqs:eu-west-2:729485541398:self-integration-EC-SQS-Output-Queue-accounts"
      KeyArn: "arn:aws:kms:eu-west-2:729485541398:key/107fc428-3843-4bd3-9e53-41d2d794e62e"
    production:
      QueueArn: "arn:aws:sqs:eu-west-2:451773080033:self-production-EC-SQS-Output-Queue-accounts"
      KeyArn: "arn:aws:kms:eu-west-2:451773080033:key/e95d47b6-613d-4bea-93c9-d400cdfb31ee"

  IPVCoreAccounts:
    dev:
      AccountNumber: ""
    build:
      AccountNumber: "457601271792"
    staging:
      AccountNumber: "335257547869"
    integration:
      AccountNumber: "991138514218"
    production:
      AccountNumber: "075701497069"

  EnvironmentVariables:
    ### These environment variables are referenced further down the file.
    ### Please ensure that any variables defined for an environment are defined for _all_ environments.
    dev:
      GOVACCOUNTSPUBLISHINGAPIURL: "https://account-api.integration.publishing.service.gov.uk"
    build:
      GOVACCOUNTSPUBLISHINGAPIURL: "https://account-api.staging.publishing.service.gov.uk"
    staging:
      GOVACCOUNTSPUBLISHINGAPIURL: "https://account-api.staging.publishing.service.gov.uk"
    integration:
      GOVACCOUNTSPUBLISHINGAPIURL: "https://account-api.integration.publishing.service.gov.uk"
    production:
      GOVACCOUNTSPUBLISHINGAPIURL: "https://account-api.publishing.service.gov.uk"

  CredentialStoreAccounts:
    dev:
      AccountNumber: "013758878511"
    build:
      AccountNumber: "688341086169"
    staging:
      AccountNumber: "922902741880"
    integration:
      AccountNumber: "406416508755"
    production:
      AccountNumber: "499563136613"

  AccountInterventionsService:
    dev:
      AccountNumber: "013758878511"
    build:
      AccountNumber: "688341086169"
    staging:
      AccountNumber: "922902741880"
    integration:
      AccountNumber: "217747075921"
    production:
      AccountNumber: "324281879537"

  TxmaAccounts:
    dev:
      AccountNumber: "248098332657"
    build:
      AccountNumber: "750703655225"
    staging:
      AccountNumber: "178023842775"
    integration:
      AccountNumber: "729485541398"
    production:
      AccountNumber: "451773080033"

  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      zendeskGroupIdSecretArn: arn:aws:secretsmanager:eu-west-2:985326104449:secret:/account-mgmt-backend/zendesk-group-id-token-1O5AvL
      zendeskTagsSecretArn: arn:aws:secretsmanager:eu-west-2:985326104449:secret:/account-mgmt-backend/zendesk-tags-key-itMbyV
      zendeskApiTokenSecretArn: arn:aws:secretsmanager:eu-west-2:985326104449:secret:/account-mgmt-backend/zendesk-api-token-urjQGc
      zendeskApiUserSecretArn: arn:aws:secretsmanager:eu-west-2:985326104449:secret:/account-mgmt-backend/zendesk-api-user-key-oPuZZU
      zendeskApiUrlSecretArn: arn:aws:secretsmanager:eu-west-2:985326104449:secret:/account-mgmt-backend/zendesk-api-url-key-nhK90l
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      zendeskGroupIdSecretArn: arn:aws:secretsmanager:eu-west-2:301577035144:secret:/account-mgmt-backend/zendesk-group-id-token-Ve5ojs
      zendeskTagsSecretArn: arn:aws:secretsmanager:eu-west-2:301577035144:secret:/account-mgmt-backend/zendesk-tags-key-H64ZpC
      zendeskApiTokenSecretArn: arn:aws:secretsmanager:eu-west-2:301577035144:secret:/account-mgmt-backend/zendesk-api-token-ayNIV1
      zendeskApiUserSecretArn: arn:aws:secretsmanager:eu-west-2:301577035144:secret:/account-mgmt-backend/zendesk-api-user-key-7jR9fV
      zendeskApiUrlSecretArn: arn:aws:secretsmanager:eu-west-2:301577035144:secret:/account-mgmt-backend/zendesk-api-url-key-UpWdv7
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      zendeskGroupIdSecretArn: arn:aws:secretsmanager:eu-west-2:539729775994:secret:/account-mgmt-backend/zendesk-group-id-token-HE0BjN
      zendeskTagsSecretArn: arn:aws:secretsmanager:eu-west-2:539729775994:secret:/account-mgmt-backend/zendesk-tags-key-IFQKUB
      zendeskApiTokenSecretArn: arn:aws:secretsmanager:eu-west-2:539729775994:secret:/account-mgmt-backend/zendesk-api-token-5HZvs4
      zendeskApiUserSecretArn: arn:aws:secretsmanager:eu-west-2:539729775994:secret:/account-mgmt-backend/zendesk-api-user-key-0AiaN0
      zendeskApiUrlSecretArn: arn:aws:secretsmanager:eu-west-2:539729775994:secret:/account-mgmt-backend/zendesk-api-url-key-wGN16k
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      zendeskGroupIdSecretArn: arn:aws:secretsmanager:eu-west-2:666500506359:secret:/account-mgmt-backend/zendesk-group-id-token-djJbv6
      zendeskTagsSecretArn: arn:aws:secretsmanager:eu-west-2:666500506359:secret:/account-mgmt-backend/zendesk-tags-key-q35WDl
      zendeskApiTokenSecretArn: arn:aws:secretsmanager:eu-west-2:666500506359:secret:/account-mgmt-backend/zendesk-api-token-fByFIz
      zendeskApiUserSecretArn: arn:aws:secretsmanager:eu-west-2:666500506359:secret:/account-mgmt-backend/zendesk-api-user-key-oVvUI5
      zendeskApiUrlSecretArn: arn:aws:secretsmanager:eu-west-2:666500506359:secret:/account-mgmt-backend/zendesk-api-url-key-b5ToSY
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
      zendeskGroupIdSecretArn: arn:aws:secretsmanager:eu-west-2:026991849909:secret:/account-mgmt-backend/zendesk-group-id-token-mE55Wr
      zendeskTagsSecretArn: arn:aws:secretsmanager:eu-west-2:026991849909:secret:/account-mgmt-backend/zendesk-tags-key-FAHfJf
      zendeskApiTokenSecretArn: arn:aws:secretsmanager:eu-west-2:026991849909:secret:/account-mgmt-backend/zendesk-api-token-aZOj3s
      zendeskApiUserSecretArn: arn:aws:secretsmanager:eu-west-2:026991849909:secret:/account-mgmt-backend/zendesk-api-user-key-cMCENu
      zendeskApiUrlSecretArn: arn:aws:secretsmanager:eu-west-2:026991849909:secret:/account-mgmt-backend/zendesk-api-url-key-WNGekL


Resources:
  ######################################
  # Dummy events store
  ######################################
  DummyEventStore:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      BillingMode: PAY_PER_REQUEST
      TableName: !Ref DummyEventStoreTableName
      KeySchema:
        - AttributeName: id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !GetAtt DatabaseKmsKey.Arn
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructure/template.yaml"

  ######################################
  # Raw events store
  ######################################
  RawEventsStore:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      BillingMode: PAY_PER_REQUEST
      TableName: !Ref RawEventsStoreTableName
      KeySchema:
        - AttributeName: id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !GetAtt DatabaseKmsKey.Arn
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      TimeToLiveSpecification:
        AttributeName: remove_at
        Enabled: true
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructure/template.yaml"

  ######################################
  # User services store
  ######################################
  UserServicesStore:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      TableName: !Ref UserServicesStoreTableName
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructre/template.yaml"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !GetAtt DatabaseKmsKey.Arn

  #########################
  # User Activity Log store
  #########################
  UserActivityLogsStore:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Ref ActivityLogsStoreTableName
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: event_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: event_id
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !GetAtt DatabaseKmsKey.Arn
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructre/template.yaml"

  ######################################
  # TxMA Event Queue (Dummy for now)
  ######################################
  TxMAInputDummyQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  ########################################
  # Output queue for audit events to TxMA
  ########################################

  AuditOutputQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !Ref AuditEncryptionKey
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 70
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AuditDeadLetterQueue.Arn
        maxReceiveCount: 5
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  AuditOutputQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref AuditOutputQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: !FindInMap [TxmaAccounts, !Ref Environment, AccountNumber]
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
              - sqs:ReceiveMessage
            Resource: !GetAtt AuditOutputQueue.Arn

  AuditDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !Ref AuditEncryptionKey
      MessageRetentionPeriod: 1209600
      RedriveAllowPolicy:
        redrivePermission: allowAll
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  AuditEncryptionKey:
    Type: AWS::KMS::Key
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              AWS: !FindInMap [TxmaAccounts, !Ref Environment, AccountNumber]
            Action: kms:Decrypt
            Resource:
              - "*"

  AuditEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/AuditEncryptionKey"
      TargetKeyId: !Ref AuditEncryptionKey

  AuditQueueArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ARN of the audit event output queue
      Name: !Sub "/${AWS::StackName}/SQS/AuditQueue/ARN"
      Type: String
      Value: !GetAtt AuditOutputQueue.Arn

  AuditQueueUrlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The URL of the audit event output queue
      Name: !Sub "/${AWS::StackName}/SQS/AuditQueue/URL"
      Type: String
      Value: !Ref AuditOutputQueue

  AuditQueueKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ARN of the KMS key encrypting the audit event output queue
      Name: !Sub "/${AWS::StackName}/KMS/AuditQueueKey/ARN"
      Type: String
      Value: !GetAtt AuditEncryptionKey.Arn

  ######################
  # Save Raw Events
  ######################
  SaveRawEventsFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - SaveRawEventsFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-save-raw-events
      CodeUri: src
      PackageType: Zip
      Events:
        InputQueue:
          Type: SQS
          Properties:
            Queue: !If
              - UseInternalEvents
              - !GetAtt TxMAInputDummyQueue.Arn
              - !FindInMap [InputQueue, !Ref Environment, QueueArn]
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt SaveRawEventsDeadLetterQueue.Arn
      Handler: save-raw-events.handler
      Role: !GetAtt SaveRawEventsRole.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref RawEventsStoreTableName
          DLQ_URL: !Ref SaveRawEventsDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - save-raw-events.ts

  SaveRawEventsDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  SaveRawEventsRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref SaveRawEventsPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  SaveRawEventsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !If
              - UseInternalEvents
              - !GetAtt TxMAInputDummyQueue.Arn
              - !FindInMap [InputQueue, !Ref Environment, QueueArn]
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt SaveRawEventsDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Resource:
              - !GetAtt RawEventsStore.Arn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt RawEventsStore.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
              - !If
                - UseInternalEvents
                - !Ref AWS::NoValue
                - !FindInMap [InputQueue, !Ref Environment, KeyArn]

  SaveRawEventsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-save-raw-events"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  SaveRawEventsCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref SaveRawEventsFunctionLogGroup

  SaveDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [!Ref AWS::StackName, !Ref Environment, SaveDeadLetterQueueAlarm],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt SaveRawEventsDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  ########################
  # Querying User Services
  ########################
  QueryUserServicesFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - QueryUserServicesFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-query-user-services
      CodeUri: src
      PackageType: Zip
      Events:
        DynamoStream:
          Type: DynamoDB
          Properties:
            BatchSize: 1
            Stream: !GetAtt RawEventsStore.StreamArn
            Enabled: true
            DestinationConfig:
              OnFailure:
                Destination: !GetAtt QueryUserServicesDeadLetterQueue.Arn
            StartingPosition: LATEST
            FilterCriteria:
              Filters:
                - Pattern: '{ "eventName": ["INSERT"] }'
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt QueryUserServicesDeadLetterQueue.Arn
      Handler: query-user-services.handler
      Role: !GetAtt QueryUserServicesRole.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref UserServicesStoreTableName
          DLQ_URL: !Ref QueryUserServicesDeadLetterQueue
          OUTPUT_QUEUE_URL: !Ref UserServicesToFormatQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - query-user-services.ts

  QueryUserServicesDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  QueryUserServicesRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref QueryUserServicesPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  QueryUserServicesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt TxMAInputDummyQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt UserServicesToFormatQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt QueryUserServicesDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:Query
              - dynamodb:GetItem
            Resource:
              - !GetAtt UserServicesStore.Arn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt UserServicesStore.Arn
          - Effect: Allow
            Action:
              - dynamodb:DescribeStream
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:ListStreams
            Resource:
              - !GetAtt RawEventsStore.StreamArn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt RawEventsStore.StreamArn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn

  QueryUserServicesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-query-user-services"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  QueryUserServicesCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref QueryUserServicesFunctionLogGroup

  UserServicesToFormatQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  QueryDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [!Ref AWS::StackName, !Ref Environment, QueryDeadLetterQueueAlarm],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt QueryUserServicesDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  #################################
  # Formatting User Services Record
  #################################
  FormatUserServicesFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - FormatUserServicesFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-format-user-services
      CodeUri: src
      PackageType: Zip
      Events:
        UserServicesToFormatQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt UserServicesToFormatQueue.Arn
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt FormatUserServicesDeadLetterQueue.Arn
      Handler: format-user-services.handler
      Role: !GetAtt FormatUserServicesRole.Arn
      Environment:
        Variables:
          DLQ_URL: !Ref FormatUserServicesDeadLetterQueue
          OUTPUT_QUEUE_URL: !Ref UserServicesToWriteQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - format-user-services.ts

  FormatUserServicesDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  FormatUserServicesRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref FormatUserServicesPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  FormatUserServicesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt UserServicesToFormatQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt FormatUserServicesDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt UserServicesToWriteQueue.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: !GetAtt QueueKmsKey.Arn

  FormatUserServicesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-format-user-services"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  FormatUserServicesCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref FormatUserServicesFunctionLogGroup

  UserServicesToWriteQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  FormatDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [!Ref AWS::StackName, !Ref Environment, FormatDeadLetterQueueAlarm],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt FormatUserServicesDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  #########################
  # Write the User Services
  #########################
  WriteUserServicesFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - WriteUserServicesFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-write-user-services
      CodeUri: src
      PackageType: Zip
      Events:
        UserServicesToWriteQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt UserServicesToWriteQueue.Arn
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt WriteUserServicesDeadLetterQueue.Arn
      Handler: write-user-services.handler
      Role: !GetAtt WriteServiceRecordRole.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref UserServicesStoreTableName
          DLQ_URL: !Ref WriteUserServicesDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - write-user-services.ts

  WriteUserServicesDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  WriteServiceRecordRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref WriteServiceRecordPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  WriteServiceRecordPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt UserServicesToWriteQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt WriteUserServicesDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Resource:
              - !GetAtt UserServicesStore.Arn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt UserServicesStore.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn

  WriteUserServicesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-write-user-services"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  WriteUserServicesCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref WriteUserServicesFunctionLogGroup

  WriteUserServicesDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            WriteUserServicesDeadLetterQueueAlarm,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt WriteUserServicesDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  ##################################
  # Notification of Account Deletion
  ##################################
  UserAccountDeletionTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: UserAccountDeletionTopic
      KmsMasterKeyId: !Ref SnsKmsKey
      TopicName: UserAccountDeletion

  UserAccountDeletionTopicPolicy:
    Condition: IsNotDevelopment
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref UserAccountDeletionTopic
      PolicyDocument:
        Statement:
          - Sid: "Allow IPV Core"
            Effect: Allow
            Principal:
              AWS: !Join
                - ""
                - - "arn:aws:iam::"
                  - !FindInMap [
                      IPVCoreAccounts,
                      !Ref Environment,
                      "AccountNumber",
                    ]
                  - ":root"
            Action: sns:Subscribe
            Resource:
              - !Ref UserAccountDeletionTopic
          - Sid: "Allow Credential store"
            Effect: Allow
            Principal:
              AWS: !Join
                - ""
                - - "arn:aws:iam::"
                  - !FindInMap [
                      CredentialStoreAccounts,
                      !Ref Environment,
                      "AccountNumber",
                    ]
                  - ":root"
            Action: sns:Subscribe
            Resource:
              - !Ref UserAccountDeletionTopic
          - Sid: "Allow Account Interventions Service"
            Effect: Allow
            Principal:
              AWS: !Join
                - ""
                - - "arn:aws:iam::"
                  - !FindInMap [
                    AccountInterventionsService,
                    !Ref Environment,
                    "AccountNumber",
                  ]
                  - ":root"
            Action: sns:Subscribe
            Resource:
              - !Ref UserAccountDeletionTopic

  DeleteTopicArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ARN of the Delete Event Topic
      Name: !Sub "/${AWS::StackName}/SNS/DeleteTopic/ARN"
      Type: String
      Value: !Ref UserAccountDeletionTopic

  ################################
  # Deleting User Services Records
  ################################
  DeleteUserServicesSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt DeleteUserServicesFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt UserAccountDeletionTopicDeadLetterQueue.Arn
      TopicArn: !Ref UserAccountDeletionTopic

  DeleteUserServicesLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: UserAccountDeletionTopic
      FunctionName: !GetAtt DeleteUserServicesFunction.Arn

  DeleteUserServicesFunction:
    DependsOn:
      - DeleteUserServicesFunctionLogGroup
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-delete-user-services
      CodeUri: src
      PackageType: Zip
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeleteUserServicesDeadLetterQueue.Arn
      Handler: delete-user-services.handler
      Role: !GetAtt DeleteUserServicesRole.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref UserServicesStoreTableName
          DLQ_URL: !Ref DeleteUserServicesDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - delete-user-services.ts

  DeleteUserServicesRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref DeleteUserServicesPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  DeleteUserServicesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt DeleteUserServicesDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt UserServicesStore.Arn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt UserServicesStore.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
              - !GetAtt LoggingKmsKey.Arn
              - !GetAtt LambdaKMSKey.Arn

  DeleteUserServicesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-delete-user-services"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  DeleteUserServicesCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref DeleteUserServicesFunctionLogGroup

  DeleteUserServicesDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  UserAccountDeletionTopicDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  UserAccountDeletionTopicDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref UserAccountDeletionTopicDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt UserAccountDeletionTopicDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref UserAccountDeletionTopic

  UserAccountDeletionTopicDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            UserAccountDeletionTopicDeadLetterQueueAlarm,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt UserAccountDeletionTopicDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  DeleteDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [!Ref AWS::StackName, !Ref Environment, DeleteDeadLetterQueueAlarm],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt DeleteUserServicesDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  ############################
  # Delete Email Subscriptions
  ############################
  DeleteEmailSubscriptionsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt DeleteEmailSubscriptionsFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt UserAccountDeletionTopicSubscriptionDeleteEmailSubscriptionsDeadLetterQueue.Arn
      TopicArn: !Ref UserAccountDeletionTopic

  UserAccountDeletionTopicSubscriptionDeleteEmailSubscriptionsDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  DeleteEmailSubscriptionsSubscriptionDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref UserAccountDeletionTopicSubscriptionDeleteEmailSubscriptionsDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt UserAccountDeletionTopicSubscriptionDeleteEmailSubscriptionsDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref UserAccountDeletionTopic

  DeleteEmailSubscriptionsLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: UserAccountDeletionTopic
      FunctionName: !GetAtt DeleteEmailSubscriptionsFunction.Arn

  DeleteEmailSubscriptionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-delete-email-subscriptions
      CodeUri: src
      PackageType: Zip
      Handler: delete-email-subscriptions.handler
      Role: !GetAtt DeleteEmailSubscriptionsRole.Arn
      Timeout: 30
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: Lambda
            Destination: !GetAtt DeleteEmailSubscriptionsDeadLetterQueue.Arn
        MaximumRetryAttempts: 2
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeleteEmailSubscriptionsDeadLetterQueue.Arn
      Environment:
        Variables:
          DLQ_URL: !Ref DeleteEmailSubscriptionsDeadLetterQueue
          GOV_ACCOUNTS_PUBLISHING_API_TOKEN: !Sub "{{resolve:secretsmanager:/${AccountManagementFrontendStackName}/Config/Publishing/API/Key}}"
          GOV_ACCOUNTS_PUBLISHING_API_URL:
            !FindInMap [
              EnvironmentVariables,
              !Ref Environment,
              GOVACCOUNTSPUBLISHINGAPIURL,
            ]
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - delete-email-subscriptions.ts

  DeleteEmailSubscriptionsDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  DeleteEmailSubscriptionsRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref DeleteEmailSubscriptionsPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  DeleteEmailSubscriptionsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt DeleteEmailSubscriptionsDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt LoggingKmsKey.Arn
              - !GetAtt LambdaKMSKey.Arn

  DeleteEmailSubscriptionsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
      - DeleteEmailSubscriptionsFunction
    Properties:
      LogGroupName: !Sub "/aws/lambda/${DeleteEmailSubscriptionsFunction}"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  DeleteEmailSubscriptionsCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref DeleteEmailSubscriptionsFunctionLogGroup

  ActivityLogsToFormatQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  ###################
  # Write Activity Log
  ###################
  WriteActivityLogFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - WriteActivityLogFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-write-activity-log
      CodeUri: src
      PackageType: Zip
      Events:
        ActivityLogToWriteQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt ActivityLogToWriteQueue.Arn
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt WriteActivityLogDeadLetterQueue.Arn
      Handler: write-activity-log.handler
      Role: !GetAtt WriteActivityRecordRole.Arn
      Environment:
        Variables:
          TABLE_NAME: "ActivityLogsStoreTableName"
          DLQ_URL: !Ref WriteActivityLogDeadLetterQueue
          GENERATOR_KEY_ARN: !GetAtt GeneratorKey.Arn
          WRAPPING_KEY_ARN: !GetAtt WrapperKey.Arn
          BACKUP_WRAPPING_KEY_ARN: !Sub "{{resolve:ssm:/${AWS::StackName}/${Environment}/Backup/KMS/WrappingKey/ARN}}"
          VERIFY_ACCESS_VALUE: !Sub "{{resolve:secretsmanager:/${AWS::StackName}/Config/Storage/VerificationSecret}}"
          ACCOUNT_ID: !Sub "${AWS::AccountId}"
          ENVIRONMENT: !Ref Environment
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - write-activity-log.ts

  WriteActivityLogDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  WriteActivityRecordRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref WriteActivityRecordPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  WriteActivityRecordPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt ActivityLogToWriteQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt WriteActivityLogDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Resource:
              - "UserActivityLogsStore"
              - !Sub
                - "${Arn}/*"
                - Arn: "UserActivityLogsStore"
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
          - Effect: Allow
            Action:
              - "kms:GenerateDataKey"
            Resource:
              - !GetAtt GeneratorKey.Arn
          - Effect: Allow
            Action:
              - kms:Encrypt
            Resource:
              - !GetAtt WrapperKey.Arn
              - !Sub "{{resolve:ssm:/${AWS::StackName}/${Environment}/Backup/KMS/WrappingKey/ARN}}"

  WriteActivityLogFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-write-activity-log"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  WriteActivityLogCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref WriteActivityLogFunctionLogGroup

  WriteActivityLogDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            WriteActivityLogDeadLetterQueueAlarm,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt WriteActivityLogDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  #######################
  # Formatting Activity Log
  #######################
  FormatActivityLogFunction:
    Type: AWS::Serverless::Function
    Condition: IsNotProdOrIntegration
    DependsOn:
      - FormatActivityLogFunctionLogGroup
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-format-activity-log
      CodeUri: src
      PackageType: Zip
      Events:
        DynamoStream:
          Type: DynamoDB
          Properties:
            BatchSize: 1
            Stream: !GetAtt RawEventsStore.StreamArn
            Enabled: true
            DestinationConfig:
              OnFailure:
                Destination: !GetAtt FormatActivityLogDeadLetterQueue.Arn
            StartingPosition: LATEST
            FilterCriteria:
              Filters:
                - Pattern: '{ "eventName": ["INSERT"] }'
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt FormatActivityLogDeadLetterQueue.Arn
      Handler: format-activity-log.handler
      Role: !GetAtt FormatActivityLogRole.Arn
      Environment:
        Variables:
          DLQ_URL: !Ref FormatActivityLogDeadLetterQueue
          OUTPUT_QUEUE_URL: !Ref ActivityLogToWriteQueue
          ENVIRONMENT: !Ref Environment
          ACCOUNT_ID: !Sub "${AWS::AccountId}"
          GENERATOR_KEY_ARN: !GetAtt GeneratorKey.Arn
          WRAPPING_KEY_ARN: !GetAtt WrapperKey.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - format-activity-log.ts

  FormatActivityLogDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  FormatActivityLogRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref FormatActivityLogPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  FormatActivityLogPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: "ActivityLogsToFormatQueue"
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt FormatActivityLogDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ActivityLogToWriteQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:DescribeStream
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:ListStreams
            Resource:
              - !GetAtt RawEventsStore.StreamArn
              - !Sub
                - "${Arn}/*"
                - Arn: !GetAtt RawEventsStore.StreamArn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - !GetAtt WrapperKey.Arn
              - !GetAtt GeneratorKey.Arn

  FormatActivityLogFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-format-activity-log"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  FormatActivityLogCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref FormatActivityLogFunctionLogGroup

  ActivityLogToWriteQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  FormatActivityLogDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            FormatActivityLogDeadLetterQueueAlarm,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt FormatActivityLogDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  ################################
  # Deleting Activity Log Records
  ################################
  DeleteActivityLogSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt DeleteActivityLogFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DeleteActivityLogSubscriptionDeadLetterQueue.Arn
      TopicArn: !Ref UserAccountDeletionTopic

  DeleteActivityLogSubscriptionDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  DeleteActivityLogSubscriptionDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref DeleteActivityLogSubscriptionDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt DeleteActivityLogSubscriptionDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref UserAccountDeletionTopic

  DeleteActivityLogSubscriptionDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            DeleteActivityLogSubscriptionDeadLetterQueue,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt DeleteActivityLogSubscriptionDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  DeleteActivityLogFunction:
    DependsOn:
      - DeleteActivityLogFunctionLogGroup
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-delete-activity-log
      CodeUri: src
      PackageType: Zip
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeleteActivityLogDeadLetterQueue.Arn
      Handler: delete-activity-log.handler
      Role: !GetAtt DeleteActivityLogRole.Arn
      Environment:
        Variables:
          TABLE_NAME: "ActivityLogsStoreTableName"
          DLQ_URL: !Ref DeleteActivityLogDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - delete-activity-log.ts

  DeleteActivityLogRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref DeleteActivityLogPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  DeleteActivityLogPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt DeleteActivityLogDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - dynamodb:DeleteItem
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:BatchWriteItem
            Resource:
              - "UserActivityLogsStore"
              - !Sub
                - "${Arn}/*"
                - Arn: "UserActivityLogsStore"
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
              - !GetAtt LoggingKmsKey.Arn
              - !GetAtt LambdaKMSKey.Arn

  DeleteActivityLogLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: UserAccountDeletionTopic
      FunctionName: !GetAtt DeleteActivityLogFunction.Arn

  DeleteActivityLogFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-delete-activity-log"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  DeleteActivityLogCSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref DeleteActivityLogFunctionLogGroup

  DeleteActivityLogDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  DeleteActivityLogDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref DeleteActivityLogDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt DeleteActivityLogDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref UserAccountDeletionTopic

  DeleteActivityLogDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            DeleteActivityLogDeadLetterQueueAlarm,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt DeleteActivityLogDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

######################
#Mark Suspicious Activity as Reported
######################
  MarkActivityReportedSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt MarkActivityReportedFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MarkActivityReportedDeadLetterQueue.Arn
      TopicArn: !Ref SuspiciousActivityTopic


  MarkActivityReportedDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  MarkActivityReportedDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref MarkActivityReportedDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt MarkActivityReportedDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref SuspiciousActivityTopic

  MarkActivityReportedFunction:
    DependsOn:
      - MarkActivityReportedLogGroup
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-mark-activity-reported
      CodeUri: src
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt MarkActivityReportedDeadLetterQueue.Arn
      Handler: mark-activity-reported.handler
      PackageType: Zip
      Role: !GetAtt MarkActivityReportedRole.Arn
      Environment:
        Variables:
          TABLE_NAME: "ActivityLogsStoreTableName"
          INDEX_NAME: "ActivityLogsStoreEventIndexName"
          DLQ_URL: !Ref MarkActivityReportedDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - mark-activity-reported.ts

  MarkActivityReportedRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref MarkActivityReportedPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  MarkActivityReportedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt MarkActivityReportedDeadLetterQueue.Arn
              - !GetAtt AuditOutputQueue.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt LoggingKmsKey.Arn
              - !GetAtt LambdaKMSKey.Arn
              - !GetAtt AuditEncryptionKey.Arn
              - !GetAtt DatabaseKmsKey.Arn
          - Effect: Allow
            Action:
              - dynamodb:UpdateItem
              - dynamodb:Query
            Resource:
              - "UserActivityLogsStore"
              - !Sub
                - "${Arn}/*"
                - Arn: "UserActivityLogsStore"

  MarkActivityReportedInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: SuspiciousActivityTopic
      FunctionName: !GetAtt MarkActivityReportedFunction.Arn

  MarkActivityReportedLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-mark-activity-reported"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn


  ######################
  # Send Suspicious Activity to TxMA
  ######################
  SendSuspiciousActivitySubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt SendSuspiciousActivityFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SendSuspiciousActivityDeadLetterQueue.Arn
      TopicArn: !Ref SuspiciousActivityTopic

  SendSuspiciousActivityDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  SendSuspiciousActivityDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref SendSuspiciousActivityDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt SendSuspiciousActivityDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref SuspiciousActivityTopic

  SendSuspiciousActivityDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            SendSuspiciousActivityDeadLetterQueue,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt SendSuspiciousActivityDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  SendSuspiciousActivityFunction:
    DependsOn:
      - SendSuspiciousActivityFunctionLogGroup
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-send-suspicious-activity
      CodeUri: src
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt SendSuspiciousActivityDeadLetterQueue.Arn
      Handler: send-suspicious-activity.handler
      PackageType: Zip
      Role: !GetAtt SendSuspiciousActivityRole.Arn
      Environment:
        Variables:
          EVENT_NAME: HOME_REPORT_SUSPICIOUS_ACTIVITY
          DLQ_URL: !Ref SendSuspiciousActivityDeadLetterQueue
          TXMA_QUEUE_URL: !Ref AuditOutputQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - send-suspicious-activity.ts

  SendSuspiciousActivityRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref SendSuspiciousActivityPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  SendSuspiciousActivityPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt SendSuspiciousActivityDeadLetterQueue.Arn
              - !GetAtt AuditOutputQueue.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - !GetAtt QueueKmsKey.Arn
              - !GetAtt LoggingKmsKey.Arn
              - !GetAtt LambdaKMSKey.Arn
              - !GetAtt AuditEncryptionKey.Arn

  SendSuspiciousActivityLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: SuspiciousActivityTopic
      FunctionName: !GetAtt SendSuspiciousActivityFunction.Arn

  SendSuspiciousActivityFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-send-suspicious-activity"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  SendSuspiciousActivityToTxMACSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref SendSuspiciousActivityFunctionLogGroup


  ######################
  # Create ticket for suspicious activity
  ######################
  CreateSupportTicketSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt CreateSupportTicketFunction.Arn
      Protocol: lambda
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt CreateSupportTicketDeadLetterQueue.Arn
      TopicArn: !Ref SuspiciousActivityTopic

  CreateSupportTicketDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  CreateSupportTicketDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref CreateSupportTicketDeadLetterQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: "sqs:SendMessage"
            Resource: !GetAtt CreateSupportTicketDeadLetterQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn": !Ref SuspiciousActivityTopic

  CreateSupportTicketDeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        !Join [
          "-",
          [
            !Ref AWS::StackName,
            !Ref Environment,
            CreateSupportTicketDeadLetterQueue,
          ],
        ]
      Namespace: "AWS/SQS"
      MetricName: "ApproximateNumberOfMessagesVisible"
      Dimensions:
        - Name: "QueueName"
          Value: !GetAtt CreateSupportTicketDeadLetterQueue.QueueName
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      AlarmActions:
        - !Ref AlarmNotificationTopic
      ActionsEnabled: true

  CreateSupportTicketFunction:
    DependsOn:
      - CreateSupportTicketFunctionLogGroup
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Environment}-${AWS::StackName}-create-support-ticket
      CodeUri: src
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt CreateSupportTicketDeadLetterQueue.Arn
      Handler: create-support-ticket.handler
      PackageType: Zip
      Role: !GetAtt CreateSupportTicketRole.Arn
      Environment:
        Variables:
          ZENDESK_GROUP_ID_KEY: /account-mgmt-backend/zendesk-group-id-token
          ZENDESK_TAGS_KEY: /account-mgmt-backend/zendesk-tags-key
          ZENDESK_API_TOKEN_KEY: /account-mgmt-backend/zendesk-api-token
          ZENDESK_API_USER_KEY: /account-mgmt-backend/zendesk-api-user-key
          ZENDESK_API_URL_KEY: /account-mgmt-backend/zendesk-api-url-key
          DLQ_URL: !Ref CreateSupportTicketDeadLetterQueue
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - create-support-ticket.ts

  CreateSupportTicketRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref CreateSupportTicketPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"

  CreateSupportTicketPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt CreateSupportTicketDeadLetterQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource:
              - !GetAtt SecretsKmsKey.Arn
          - Effect: Allow
            Action: secretsmanager:GetSecretValue # pragma: allowlist secret
            Resource:
              - !FindInMap [ EnvironmentConfiguration, !Ref Environment, zendeskGroupIdSecretArn ]
              - !FindInMap [ EnvironmentConfiguration, !Ref Environment, zendeskTagsSecretArn ]
              - !FindInMap [ EnvironmentConfiguration, !Ref Environment, zendeskApiTokenSecretArn ]
              - !FindInMap [ EnvironmentConfiguration, !Ref Environment, zendeskApiUserSecretArn ]
              - !FindInMap [ EnvironmentConfiguration, !Ref Environment, zendeskApiUrlSecretArn ]

  CreateSupportTicketLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: SuspiciousActivityTopic
      FunctionName: !GetAtt CreateSupportTicketFunction.Arn

  CreateSupportTicketFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-${AWS::StackName}-create-support-ticket"
      RetentionInDays: 30
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  CreateSupportTicketToTxMACSLSSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref CreateSupportTicketFunctionLogGroup

  #######################
  # Monitoring
  #######################
  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: !GetAtt QueueKmsKey.Arn

  AlarmNotificationTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref AlarmNotificationTopic
      PolicyDocument:
        Statement:
          - Action: "sns:Publish"
            Effect: Allow
            Resource: !Ref AlarmNotificationTopic
            Principal:
              Service: cloudwatch.amazonaws.com

  DeadLetterEmailSubscriptions:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: govuk-accounts-developers@digital.cabinet-office.gov.uk
      Protocol: email
      TopicArn: !Ref AlarmNotificationTopic

  #######################
  # Encryption
  #######################
  QueueKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              Service: cloudwatch.amazonaws.com
            Action: kms:*
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource:
              - "*"

  QueueKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/QueueKmsKey"
      TargetKeyId: !Ref QueueKmsKey

  DatabaseKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action:
              - kms:*
            Resource:
              - "*"

  DatabaseKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/DatabaseKmsKey"
      TargetKeyId: !Ref DatabaseKmsKey

  DatabaseKmsKeyIDParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ID of the Database KMS Key
      Name: !Sub "/${AWS::StackName}/KMS/DatabaseKmsKey/ID"
      Type: String
      Value: !Ref DatabaseKmsKey

  LambdaKMSKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action:
              - "kms:*"
            Resource:
              - "*"
          - Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
            Action:
              - "kms:Decrypt"
            Resource: "*"

  LambdaKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/LambdaKMSKey"
      TargetKeyId: !Ref LambdaKMSKey

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

  LoggingKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/LoggingKmsKey"
      TargetKeyId: !Ref LoggingKmsKey

  SnsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource:
              - "*"
          - !If
            - "IsNotDevelopment"
            - Effect: Allow
              Principal:
                AWS: !Join
                  - ""
                  - - "arn:aws:iam::"
                    - !FindInMap [
                        CredentialStoreAccounts,
                        !Ref Environment,
                        "AccountNumber",
                      ]
                    - ":root"
              Action: kms:Decrypt
              Resource:
                - "*"
            - !Ref AWS::NoValue
          - !If
            - "IsNotDevelopment"
            - Effect: Allow
              Principal:
                AWS: !Join
                  - ""
                  - - "arn:aws:iam::"
                    - !FindInMap [
                      AccountInterventionsService,
                      !Ref Environment,
                      "AccountNumber",
                    ]
                    - ":root"
              Action: kms:Decrypt
              Resource:
                - "*"
            - !Ref AWS::NoValue
          - !If
            - "IsNotDevelopment"
            - Effect: Allow
              Principal:
                AWS: !Join
                  - ""
                  - - "arn:aws:iam::"
                    - !FindInMap [
                        IPVCoreAccounts,
                        !Ref Environment,
                        "AccountNumber",
                      ]
                    - ":root"
              Action: kms:Decrypt
              Resource:
                - "*"
            - !Ref AWS::NoValue
          - Effect: Allow
            Principal:
              Service: cloudwatch.amazonaws.com
            Action: kms:*
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action: kms:*
            Resource:
              - "*"

  SnsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}/${Environment}/SnsKmsKey"
      TargetKeyId: !Ref SnsKmsKey

  SnsKmsKeyIDParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ID of the SNS KMS Key
      Name: !Sub "/${AWS::StackName}/KMS/SnsKmsKey/ID"
      Type: String
      Value: !Ref SnsKmsKey

  WrapperKey:
    Type: AWS::KMS::Key
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Description: A key used to encrypt the data key for envelope encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: "Allow IAM to manage access to the key"
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructure/template.yaml"
        - Key: Name
          Value: !Sub "${AWS::StackName}-BackupWrapperKey"

  WrapperKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-WrapperKey"
      TargetKeyId: !GetAtt WrapperKey.Arn

  GeneratorKey:
    Type: AWS::KMS::Key
    Properties:
      Description: A generator key for generating a plaintext data key
      Enabled: true
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: "Allow root account access"
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource: "*"
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructure/template.yaml"
        - Key: Name
          Value: !Sub "${AWS::StackName}-GeneratorKey"

  GeneratorKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-GeneratorKey"
      TargetKeyId: !GetAtt GeneratorKey.Arn

  SecretsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "KMS key used to protect secrets data in ${AWS::StackName}"
      Enabled: true
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "secretsmanager.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/Config/Session/Secret"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-SecretsKmsKey"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  SecretsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-SecretsKmsKey"
      TargetKeyId: !GetAtt SecretsKmsKey.Arn

  StorageVerificationSecret:
    Type: AWS::SecretsManager::Secret
    DependsOn: SecretsKmsKeyAlias
    Properties:
      Name: !Sub "/${AWS::StackName}/Config/Storage/VerificationSecret"
      Description: Encryption context secret value
      GenerateSecretString:
        ExcludeLowercase: false
        ExcludeNumbers: false
        ExcludePunctuation: true
        ExcludeUppercase: false
        IncludeSpace: false
        RequireEachIncludedType: true
        PasswordLength: 32
      KmsKeyId: !Sub "alias/${AWS::StackName}-SecretsKmsKey"
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Account Management Backend
        - Key: Owner
          Value: govuk-accounts-tech@digital.cabinet-office.gov.uk
        - Key: Environment
          Value: !Ref "Environment"
        - Key: Source
          Value: "https://github.com/alphagov/di-account-management-backend/blob/main/infrastructure/template.yaml"
        - Key: Name
          Value: !Sub "${AWS::StackName}-GeneratorKey"

  StorageSecretResourcePolicy:
    Type: AWS::SecretsManager::ResourcePolicy
    Properties:
      BlockPublicPolicy: false
      SecretId: !Ref StorageVerificationSecret
      ResourcePolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: secretsmanager:GetSecretValue # pragma: allowlist secret
            Resource: !Ref StorageVerificationSecret

  BackupWrappingKeyArnSSM:
    Type: AWS::SSM::Parameter
    Properties:
      Description: "The ARN of the Wrapping KMS key in the backup account manually set with the Backup Stack's WrappingKeyArn"
      Name: !Sub "/${AWS::StackName}/${Environment}/Backup/KMS/WrappingKey/ARN"
      Type: String
      Value: "please-set-me"

  VPCFlowLogsSplunkSubscription:
    Condition: ExportLogsToSplunk
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName:
        Fn::ImportValue:
          Fn::Sub: "${VpcStackName}-FlowLogLogGroup"


  SuspiciousActivityTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: SuspiciousActivityTopic
      KmsMasterKeyId: !Ref SnsKmsKey
      TopicName: SuspiciousActivity

  SuspiciousActivityArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: The ARN of the Suspicious Activity Topic
      Name: !Sub "/${AWS::StackName}/SNS/SuspiciousActivity/ARN"
      Type: String
      Value: !Ref SuspiciousActivityTopic
